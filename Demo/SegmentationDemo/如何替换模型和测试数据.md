# å¦‚ä½•æ›¿æ¢ ONNX æ¨¡å‹å’Œæµ‹è¯•æ•°æ®

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨ SegmentationDemo é¡¹ç›®ä¸­æ›¿æ¢è‡ªå·±çš„ ONNX æ¨¡å‹å’Œæµ‹è¯•å›¾ç‰‡ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ–¹æ³•ä¸€ï¼šç›´æ¥æ›¿æ¢æ–‡ä»¶ï¼ˆæœ€ç®€å•ï¼‰](#æ–¹æ³•ä¸€ç›´æ¥æ›¿æ¢æ–‡ä»¶æœ€ç®€å•)
2. [æ–¹æ³•äºŒï¼šä¿®æ”¹ä»£ç è·¯å¾„](#æ–¹æ³•äºŒä¿®æ”¹ä»£ç è·¯å¾„)
3. [æ–¹æ³•ä¸‰ï¼šä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ï¼ˆæ¨èï¼‰](#æ–¹æ³•ä¸‰ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æ¨è)
4. [æ–¹æ³•å››ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶](#æ–¹æ³•å››ä½¿ç”¨é…ç½®æ–‡ä»¶)
5. [æ¨¡å‹è¦æ±‚è¯´æ˜](#æ¨¡å‹è¦æ±‚è¯´æ˜)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ–¹æ³•ä¸€ï¼šç›´æ¥æ›¿æ¢æ–‡ä»¶ï¼ˆæœ€ç®€å•ï¼‰

### æ›¿æ¢æ¨¡å‹

1. **æ‰¾åˆ°æ¨¡å‹ç›®å½•**ï¼š
   ```
   test/assets/Models/
   ```

2. **æ›¿æ¢æ¨¡å‹æ–‡ä»¶**ï¼š
   - å°†ä½ çš„ ONNX æ¨¡å‹æ–‡ä»¶å¤åˆ¶åˆ°è¯¥ç›®å½•
   - **é‡å‘½åä¸º** `yolov11s-seg.onnx` æˆ– `yolov8s-seg.onnx`
   - æˆ–è€…ç›´æ¥æ›¿æ¢ç°æœ‰çš„æ¨¡å‹æ–‡ä»¶

3. **æ”¯æŒçš„æ¨¡å‹æ–‡ä»¶å**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
   - `yolov11s-seg.onnx`ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰
   - `yolov8s-seg.onnx`ï¼ˆå¤‡ç”¨ï¼‰

### æ›¿æ¢æµ‹è¯•å›¾ç‰‡

1. **æ‰¾åˆ°å›¾ç‰‡ç›®å½•**ï¼š
   ```
   test/assets/Media/
   ```

2. **æ›¿æ¢å›¾ç‰‡æ–‡ä»¶**ï¼š
   - å°†ä½ çš„æµ‹è¯•å›¾ç‰‡å¤åˆ¶åˆ°è¯¥ç›®å½•
   - **é‡å‘½åä¸º** `people.jpg` æˆ– `street.jpg`
   - æˆ–è€…ç›´æ¥æ›¿æ¢ç°æœ‰çš„å›¾ç‰‡æ–‡ä»¶

3. **æ”¯æŒçš„å›¾ç‰‡æ–‡ä»¶å**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
   - `people.jpg`ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰
   - `street.jpg`ï¼ˆå¤‡ç”¨ï¼‰

### ä¼˜ç‚¹
- âœ… æ— éœ€ä¿®æ”¹ä»£ç 
- âœ… æ“ä½œç®€å•å¿«é€Ÿ
- âœ… é€‚åˆå¿«é€Ÿæµ‹è¯•

### ç¼ºç‚¹
- âŒ éœ€è¦é‡å‘½åæ–‡ä»¶
- âŒ ä¸èƒ½åŒæ—¶ä½¿ç”¨å¤šä¸ªæ¨¡å‹/å›¾ç‰‡

---

## æ–¹æ³•äºŒï¼šä¿®æ”¹ä»£ç è·¯å¾„

### ä¿®æ”¹æ¨¡å‹è·¯å¾„

æ‰“å¼€ `Demo/SegmentationDemo/Program.cs`ï¼Œæ‰¾åˆ° `GetModelPath()` æ–¹æ³•ï¼ˆçº¦ç¬¬ 234 è¡Œï¼‰ï¼š

```csharp
private static string GetModelPath()
{
    var currentDir = new DirectoryInfo(Directory.GetCurrentDirectory());
    var projectRoot = FindProjectRoot(currentDir);

    if (projectRoot != null)
    {
        // ä¿®æ”¹è¿™é‡Œï¼šæŒ‡å®šä½ çš„æ¨¡å‹æ–‡ä»¶å
        var customModel = Path.Combine(projectRoot, "test", "assets", "Models", "ä½ çš„æ¨¡å‹åç§°.onnx");
        if (File.Exists(customModel))
            return customModel;

        // æˆ–è€…ç›´æ¥è¿”å›å®Œæ•´è·¯å¾„
        // return @"C:\ä½ çš„è·¯å¾„\ä½ çš„æ¨¡å‹.onnx";
    }

    // é»˜è®¤è·¯å¾„
    return Path.Combine("test", "assets", "Models", "yolov11s-seg.onnx");
}
```

### ä¿®æ”¹å›¾ç‰‡è·¯å¾„

æ‰¾åˆ° `GetImagePath()` æ–¹æ³•ï¼ˆçº¦ç¬¬ 260 è¡Œï¼‰ï¼š

```csharp
private static string GetImagePath()
{
    var currentDir = new DirectoryInfo(Directory.GetCurrentDirectory());
    var projectRoot = FindProjectRoot(currentDir);

    if (projectRoot != null)
    {
        // ä¿®æ”¹è¿™é‡Œï¼šæŒ‡å®šä½ çš„å›¾ç‰‡æ–‡ä»¶å
        var customImage = Path.Combine(projectRoot, "test", "assets", "Media", "ä½ çš„å›¾ç‰‡åç§°.jpg");
        if (File.Exists(customImage))
            return customImage;

        // æˆ–è€…ç›´æ¥è¿”å›å®Œæ•´è·¯å¾„
        // return @"C:\ä½ çš„è·¯å¾„\ä½ çš„å›¾ç‰‡.jpg";
    }

    // é»˜è®¤è·¯å¾„
    return Path.Combine("test", "assets", "Media", "people.jpg");
}
```

### ä¼˜ç‚¹
- âœ… å¯ä»¥æŒ‡å®šä»»æ„è·¯å¾„å’Œæ–‡ä»¶å
- âœ… ä¸éœ€è¦é‡å‘½åæ–‡ä»¶

### ç¼ºç‚¹
- âŒ éœ€è¦ä¿®æ”¹ä»£ç 
- âŒ æ¯æ¬¡æ›´æ¢éœ€è¦é‡æ–°ç¼–è¯‘

---

## æ–¹æ³•ä¸‰ï¼šä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ï¼ˆæ¨èï¼‰

è¿™æ˜¯æœ€çµæ´»çš„æ–¹æ³•ï¼Œæ”¯æŒåœ¨è¿è¡Œæ—¶æŒ‡å®šæ¨¡å‹å’Œå›¾ç‰‡è·¯å¾„ã€‚

### å®ç°æ­¥éª¤

1. **ä¿®æ”¹ `Main` æ–¹æ³•**ï¼Œæ·»åŠ å‘½ä»¤è¡Œå‚æ•°æ”¯æŒï¼š

```csharp
static void Main(string[] args)
{
    CreateOutputFolder();
    SetDrawingOptions();

    // ä»å‘½ä»¤è¡Œå‚æ•°è·å–è·¯å¾„ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤æ–¹æ³•
    string modelPath;
    string imagePath;

    if (args.Length >= 1 && !string.IsNullOrWhiteSpace(args[0]))
    {
        modelPath = args[0];
    }
    else
    {
        modelPath = GetModelPath();
    }

    if (args.Length >= 2 && !string.IsNullOrWhiteSpace(args[1]))
    {
        imagePath = args[1];
    }
    else
    {
        imagePath = GetImagePath();
    }

    // åç»­ä»£ç ä¿æŒä¸å˜...
    if (!File.Exists(modelPath))
    {
        Console.WriteLine($"éŒ¯èª¤: æ‰¾ä¸åˆ°æ¨¡å‹æ–‡ä»¶: {modelPath}");
        return;
    }

    if (!File.Exists(imagePath))
    {
        Console.WriteLine($"éŒ¯èª¤: æ‰¾ä¸åˆ°åœ–ç‰‡æ–‡ä»¶: {imagePath}");
        return;
    }

    Console.WriteLine($"ä½¿ç”¨æ¨¡å‹: {modelPath}");
    Console.WriteLine($"ä½¿ç”¨åœ–ç‰‡: {imagePath}");

    // ... å…¶ä½™ä»£ç 
}
```

### ä½¿ç”¨æ–¹æ³•

#### æ–¹å¼ 1ï¼šä½¿ç”¨ dotnet CLI

```bash
# åªæŒ‡å®šæ¨¡å‹
dotnet run -- "C:\ä½ çš„è·¯å¾„\ä½ çš„æ¨¡å‹.onnx"

# æŒ‡å®šæ¨¡å‹å’Œå›¾ç‰‡
dotnet run -- "C:\ä½ çš„è·¯å¾„\ä½ çš„æ¨¡å‹.onnx" "C:\ä½ çš„è·¯å¾„\ä½ çš„å›¾ç‰‡.jpg"

# ä½¿ç”¨ç›¸å¯¹è·¯å¾„
dotnet run -- "test/assets/Models/ä½ çš„æ¨¡å‹.onnx" "test/assets/Media/ä½ çš„å›¾ç‰‡.jpg"
```

#### æ–¹å¼ 2ï¼šä½¿ç”¨ Visual Studio

1. å³é”®ç‚¹å‡» `SegmentationDemo` é¡¹ç›®
2. é€‰æ‹©"å±æ€§" â†’ "è°ƒè¯•" â†’ "å¸¸è§„"
3. åœ¨"å‘½ä»¤è¡Œå‚æ•°"ä¸­è¾“å…¥ï¼š
   ```
   "C:\ä½ çš„è·¯å¾„\ä½ çš„æ¨¡å‹.onnx" "C:\ä½ çš„è·¯å¾„\ä½ çš„å›¾ç‰‡.jpg"
   ```

#### æ–¹å¼ 3ï¼šç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶

```bash
# ç¼–è¯‘åè¿è¡Œ
SegmentationDemo.exe "C:\ä½ çš„è·¯å¾„\ä½ çš„æ¨¡å‹.onnx" "C:\ä½ çš„è·¯å¾„\ä½ çš„å›¾ç‰‡.jpg"
```

### ä¼˜ç‚¹
- âœ… æœ€çµæ´»ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
- âœ… å¯ä»¥å¿«é€Ÿåˆ‡æ¢ä¸åŒçš„æ¨¡å‹å’Œå›¾ç‰‡
- âœ… é€‚åˆæ‰¹é‡å¤„ç†

### ç¼ºç‚¹
- âŒ éœ€è¦ä¿®æ”¹ä¸€æ¬¡ä»£ç ï¼ˆæ·»åŠ å‚æ•°æ”¯æŒï¼‰

---

## æ–¹æ³•å››ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶

åˆ›å»ºä¸€ä¸ª JSON é…ç½®æ–‡ä»¶æ¥ç®¡ç†æ¨¡å‹å’Œå›¾ç‰‡è·¯å¾„ã€‚

### å®ç°æ­¥éª¤

1. **åˆ›å»ºé…ç½®æ–‡ä»¶** `config.json`ï¼š

```json
{
  "ModelPath": "test/assets/Models/yolov11s-seg.onnx",
  "ImagePath": "test/assets/Media/people.jpg",
  "Confidence": 0.24,
  "PixelConfidence": 0.5,
  "IoU": 0.7
}
```

2. **æ·»åŠ  NuGet åŒ…**ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š
   - `Newtonsoft.Json` æˆ– `System.Text.Json`

3. **ä¿®æ”¹ä»£ç è¯»å–é…ç½®**ï¼š

```csharp
using System.Text.Json;

// åœ¨ Main æ–¹æ³•å¼€å§‹å¤„
var configPath = Path.Combine(AppContext.BaseDirectory, "config.json");
Config config;

if (File.Exists(configPath))
{
    var json = File.ReadAllText(configPath);
    config = JsonSerializer.Deserialize<Config>(json);
}
else
{
    // ä½¿ç”¨é»˜è®¤é…ç½®
    config = new Config
    {
        ModelPath = GetModelPath(),
        ImagePath = GetImagePath(),
        Confidence = 0.24,
        PixelConfidence = 0.5,
        IoU = 0.7
    };
}

// ä½¿ç”¨é…ç½®
var modelPath = config.ModelPath;
var imagePath = config.ImagePath;

// åœ¨æ¨ç†æ—¶ä½¿ç”¨é…ç½®çš„å‚æ•°
var results = yolo.RunSegmentation(
    image, 
    confidence: config.Confidence, 
    pixelConfedence: config.PixelConfidence, 
    iou: config.IoU
);
```

4. **æ·»åŠ é…ç½®ç±»**ï¼š

```csharp
public class Config
{
    public string ModelPath { get; set; }
    public string ImagePath { get; set; }
    public float Confidence { get; set; }
    public float PixelConfidence { get; set; }
    public float IoU { get; set; }
}
```

### ä¼˜ç‚¹
- âœ… å¯ä»¥åŒæ—¶é…ç½®å¤šä¸ªå‚æ•°
- âœ… ä¸éœ€è¦é‡æ–°ç¼–è¯‘
- âœ… é€‚åˆç”Ÿäº§ç¯å¢ƒ

### ç¼ºç‚¹
- âŒ éœ€è¦é¢å¤–çš„ä¾èµ–å’Œä»£ç 

---

## æ¨¡å‹è¦æ±‚è¯´æ˜

### ONNX æ¨¡å‹è¦æ±‚

1. **æ¨¡å‹ç±»å‹**ï¼š
   - å¿…é¡»æ˜¯ **åˆ†å‰²æ¨¡å‹**ï¼ˆSegmentation Modelï¼‰
   - æ”¯æŒ YOLOv5-v12 çš„åˆ†å‰²æ¨¡å‹

2. **æ¨¡å‹æ ¼å¼**ï¼š
   - å¿…é¡»æ˜¯ `.onnx` æ ¼å¼
   - æ¨¡å‹å¿…é¡»æ­£ç¡®å¯¼å‡ºï¼ˆä½¿ç”¨ Ultralytics çš„ `export` åŠŸèƒ½ï¼‰

3. **è¾“å…¥è¾“å‡ºè¦æ±‚**ï¼š
   - **è¾“å…¥**ï¼šå›¾åƒå¼ é‡ï¼Œé€šå¸¸ä¸º `[1, 3, 640, 640]`ï¼ˆbatch, channels, height, widthï¼‰
   - **è¾“å‡º**ï¼šåŒ…å«è¾¹ç•Œæ¡†ã€ç½®ä¿¡åº¦ã€ç±»åˆ«å’Œåˆ†å‰²æ©ç 

4. **å¯¼å‡ºæ¨¡å‹ç¤ºä¾‹**ï¼ˆä½¿ç”¨ Ultralyticsï¼‰ï¼š

```python
from ultralytics import YOLO

# åŠ è½½æ¨¡å‹
model = YOLO('yolov11s-seg.pt')  # æˆ–ä½ çš„è‡ªå®šä¹‰æ¨¡å‹

# å¯¼å‡ºä¸º ONNX
model.export(format='onnx', imgsz=640)
```

### æµ‹è¯•å›¾ç‰‡è¦æ±‚

1. **å›¾ç‰‡æ ¼å¼**ï¼š
   - æ”¯æŒå¸¸è§æ ¼å¼ï¼š`.jpg`, `.jpeg`, `.png`, `.bmp`
   - æ¨èä½¿ç”¨ `.jpg` æ ¼å¼ï¼ˆæ–‡ä»¶å°ï¼ŒåŠ è½½å¿«ï¼‰

2. **å›¾ç‰‡å°ºå¯¸**ï¼š
   - æ— ç‰¹æ®Šè¦æ±‚ï¼Œç¨‹åºä¼šè‡ªåŠ¨è°ƒæ•´
   - å»ºè®®ä½¿ç”¨ 640x640 æˆ–æ›´å¤§å°ºå¯¸ä»¥è·å¾—æ›´å¥½æ•ˆæœ

3. **å›¾ç‰‡å†…å®¹**ï¼š
   - ç¡®ä¿å›¾ç‰‡åŒ…å«ä½ æƒ³è¦æ£€æµ‹çš„å¯¹è±¡
   - å¯¹äºåˆ†å‰²ä»»åŠ¡ï¼Œå»ºè®®ä½¿ç”¨åŒ…å«å¤šä¸ªå¯¹è±¡çš„å›¾ç‰‡

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•çŸ¥é“æˆ‘çš„æ¨¡å‹æ˜¯å¦å…¼å®¹ï¼Ÿ

**A**: è¿è¡Œç¨‹åºåï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š
- å¦‚æœæ˜¾ç¤º `Loaded ONNX Model: Segmentation (yolo v11)` æˆ–ç±»ä¼¼ä¿¡æ¯ï¼Œè¯´æ˜æ¨¡å‹åŠ è½½æˆåŠŸ
- å¦‚æœå‡ºç°é”™è¯¯ï¼Œå¯èƒ½æ˜¯æ¨¡å‹æ ¼å¼ä¸å…¼å®¹

### Q2: å¯ä»¥ä½¿ç”¨å…¶ä»–ç±»å‹çš„æ¨¡å‹å—ï¼ˆå¦‚ç›®æ ‡æ£€æµ‹ï¼‰ï¼Ÿ

**A**: ä¸å¯ä»¥ã€‚`SegmentationDemo` ä¸“é—¨ç”¨äºåˆ†å‰²ä»»åŠ¡ã€‚å¦‚æœè¦ä½¿ç”¨ç›®æ ‡æ£€æµ‹æ¨¡å‹ï¼Œè¯·ä½¿ç”¨ `ObjectDetectionDemo`ã€‚

### Q3: æ¨¡å‹è·¯å¾„å¯ä»¥æ˜¯ç½‘ç»œè·¯å¾„å—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†éœ€è¦ç¡®ä¿ï¼š
- ç½‘ç»œè·¯å¾„å¯è®¿é—®
- è·¯å¾„æ ¼å¼æ­£ç¡®ï¼ˆå¦‚ `\\server\share\model.onnx`ï¼‰

### Q4: å¦‚ä½•æ‰¹é‡å¤„ç†å¤šå¼ å›¾ç‰‡ï¼Ÿ

**A**: å¯ä»¥ä¿®æ”¹ä»£ç æ·»åŠ å¾ªç¯ï¼š

```csharp
var imageFiles = Directory.GetFiles(imageDirectory, "*.jpg");
foreach (var imageFile in imageFiles)
{
    using var image = SKBitmap.Decode(imageFile);
    var results = yolo.RunSegmentation(image, 0.24, 0.5, 0.7);
    // å¤„ç†ç»“æœ...
}
```

### Q5: æ›¿æ¢æ¨¡å‹åæ£€æµ‹ç»“æœä¸å¯¹ï¼Ÿ

**A**: å¯èƒ½çš„åŸå› ï¼š
1. æ¨¡å‹ç±»åˆ«æ•°ä¸åŒï¼ˆå¦‚è‡ªå®šä¹‰æ¨¡å‹åªæœ‰ 1 ä¸ªç±»åˆ«ï¼Œä½†ä»£ç æœŸæœ› 80 ä¸ªç±»åˆ«ï¼‰
2. æ¨¡å‹è¾“å…¥å°ºå¯¸ä¸åŒ
3. æ¨¡å‹å¯¼å‡ºæœ‰é—®é¢˜

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥æ¨¡å‹çš„ç±»åˆ«æ•°æ˜¯å¦åŒ¹é…
- ç¡®è®¤æ¨¡å‹æ­£ç¡®å¯¼å‡ºä¸º ONNX æ ¼å¼
- æŸ¥çœ‹æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“ æ€»ç»“

| æ–¹æ³• | éš¾åº¦ | çµæ´»æ€§ | é€‚ç”¨åœºæ™¯ |
|------|------|--------|----------|
| æ–¹æ³•ä¸€ï¼šç›´æ¥æ›¿æ¢ | â­ ç®€å• | â­â­ ä½ | å¿«é€Ÿæµ‹è¯• |
| æ–¹æ³•äºŒï¼šä¿®æ”¹ä»£ç  | â­â­ ä¸­ç­‰ | â­â­â­ ä¸­ | å›ºå®šè·¯å¾„ |
| æ–¹æ³•ä¸‰ï¼šå‘½ä»¤è¡Œå‚æ•° | â­â­ ä¸­ç­‰ | â­â­â­â­ é«˜ | **æ¨è** |
| æ–¹æ³•å››ï¼šé…ç½®æ–‡ä»¶ | â­â­â­ è¾ƒéš¾ | â­â­â­â­â­ å¾ˆé«˜ | ç”Ÿäº§ç¯å¢ƒ |

**æ¨èä½¿ç”¨é¡ºåº**ï¼š
1. å¿«é€Ÿæµ‹è¯•ï¼šä½¿ç”¨æ–¹æ³•ä¸€
2. æ—¥å¸¸ä½¿ç”¨ï¼šä½¿ç”¨æ–¹æ³•ä¸‰ï¼ˆå‘½ä»¤è¡Œå‚æ•°ï¼‰
3. ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨æ–¹æ³•å››ï¼ˆé…ç½®æ–‡ä»¶ï¼‰

---

## ğŸ”— ç›¸å…³èµ„æº

- [YoloDotNet GitHub](https://github.com/NickSwardh/YoloDotNet)
- [Ultralytics æ–‡æ¡£](https://docs.ultralytics.com/)
- [ONNX æ¨¡å‹å¯¼å‡ºæŒ‡å—](https://docs.ultralytics.com/modes/export/)

---

**æœ€åæ›´æ–°**ï¼š2025å¹´  
**ç‰ˆæœ¬**ï¼šv1.0

