# IndustrySeg2 項目全面分析報告

## 📋 項目概述

**IndustrySeg2** 是一個基於 YOLO 模型的工業產品表面缺陷檢測系統，使用 C# (.NET 8) 開發，提供完整的圖形界面和自動化監控功能。

### 核心技術棧
- **框架**: .NET 8.0
- **UI**: WPF (Windows Presentation Foundation)
- **圖像處理**: SkiaSharp 3.119.1
- **AI 推理**: YOLO 模型 (YOLOv5u-v12, YOLO-World, YOLO-E)
- **推理引擎**: ONNX Runtime (模塊化執行提供者)
- **輔助工具**: Python 虛擬工控機模擬器

---

## 🏗️ 項目架構

### 1. 核心庫層 (YoloDotNet)

#### 1.1 主要組件

**YoloDotNet** 是項目的核心推理庫，採用模塊化架構設計：

```
YoloDotNet/
├── Core/                    # 核心引擎
│   ├── YoloCore.cs         # YOLO 核心類，處理模型初始化和推理
│   ├── ModuleFactory.cs    # 模塊工廠，根據模型版本創建對應模塊
│   └── InferenceResult.cs  # 推理結果封裝
│
├── Modules/                 # 模型版本模塊
│   ├── V5U/               # YOLOv5u 模塊
│   ├── V8/                # YOLOv8 模塊（分類、檢測、分割、姿態估計）
│   ├── V9/                # YOLOv9 模塊
│   ├── V10/               # YOLOv10 模塊
│   ├── V11/               # YOLOv11 模塊
│   ├── V11E/              # YOLOv11-E 模塊
│   ├── V12/               # YOLOv12 模塊
│   ├── V8E/               # YOLOv8-E 模塊
│   ├── WorldV2/            # YOLO-World v2 模塊
│   └── Interfaces/         # 模塊接口定義
│
├── Models/                 # 數據模型
│   ├── Classification.cs   # 分類結果模型
│   ├── ObjectDetection.cs # 目標檢測結果模型
│   ├── Segmentation.cs    # 分割結果模型
│   ├── PoseEstimation.cs  # 姿態估計結果模型
│   └── OBBDetection.cs     # 定向邊界框檢測結果模型
│
├── Execution Providers/    # 執行提供者（已分離為獨立包）
│   ├── Cpu/               # CPU 執行提供者
│   ├── Cuda/              # CUDA/TensorRT 執行提供者
│   ├── OpenVINO/          # Intel OpenVINO 執行提供者
│   └── CoreML/            # Apple CoreML 執行提供者
│
├── Extensions/            # 擴展方法
│   ├── ImageExtension.cs  # 圖像處理擴展
│   ├── TrackerExtension.cs # 追蹤擴展
│   └── ...
│
├── Trackers/              # 目標追蹤
│   ├── SortTracker.cs     # SORT 追蹤算法
│   ├── TailTrack.cs       # TailTrack 追蹤算法
│   └── KalmanFilter.cs    # 卡爾曼濾波器
│
└── Video/                 # 視頻處理
    ├── FFmpegService.cs    # FFmpeg 視頻服務
    └── VideoOptions.cs    # 視頻選項配置
```

#### 1.2 支持的任務類型

| 任務類型 | 支持版本 | 說明 |
|---------|---------|------|
| **分類 (Classification)** | V8, V11 | 圖像分類 |
| **目標檢測 (Object Detection)** | V5U, V8, V9, V10, V11, V12 | 邊界框檢測 |
| **分割 (Segmentation)** | V8, V11, V11E | 語義分割 |
| **姿態估計 (Pose Estimation)** | V8, V11 | 人體關鍵點檢測 |
| **定向邊界框 (OBB)** | V8 | 旋轉邊界框檢測 |
| **YOLO-World** | WorldV2 | 開放詞彙檢測 |
| **YOLO-E** | V8E, V11E | 提示式分割 |

#### 1.3 執行提供者架構 (v4.0 重大變更)

**v4.0 引入模塊化執行提供者架構**：
- 核心庫不再包含任何 ONNX Runtime 依賴
- 執行提供者作為獨立的 NuGet 包
- 每個項目只能引用一個執行提供者
- 支持平台：
  - **CPU**: Windows, Linux, macOS
  - **CUDA/TensorRT**: Windows, Linux (NVIDIA GPU)
  - **OpenVINO**: Windows, Linux (Intel CPU/iGPU)
  - **CoreML**: macOS (Apple Silicon/Intel)

---

### 2. 應用層 (IndustrySegSys)

#### 2.1 主要功能

**IndustrySegSys** 是工業檢測系統的主應用程序，提供兩種工作模式：

##### 自動監控模式
- **目錄監控**: 監控指定目錄，自動檢測新創建的料號目錄
- **多級監控**: 
  - 第一級：監控根目錄下的料號目錄（如 `202512290001`）
  - 第二級：為每個料號目錄創建監控器，監控工站目錄（如 `S1`, `S2`, `S3`）
- **自動處理**: 檢測到新目錄時自動處理其中的圖片
- **目錄結構保持**: 輸出結果保持原有的料號/工站目錄結構

##### 手動處理模式
- **單文件處理**: 處理單張圖片
- **批量處理**: 處理整個目錄的圖片
- **實時參數調整**: 可調整 Confidence、Pixel Confidence、IoU 閾值
- **進度顯示**: 顯示處理進度和處理速度

#### 2.2 目錄結構要求

**監控模式期望的目錄結構**：
```
監控根目錄/
├── 202512290001/          # 料號目錄（日期+料號）
│   ├── S1/               # 工站1
│   │   ├── 1.png
│   │   ├── 2.png
│   │   └── ...
│   ├── S2/               # 工站2
│   │   └── ...
│   └── S3/               # 工站3
│       └── ...
├── 202512290002/          # 下一個料號
│   └── ...
└── ...
```

**輸出目錄結構**（保持相同結構）：
```
輸出目錄/
├── 202512290001/
│   ├── S1/
│   │   ├── 1_NG.png      # 檢測到缺陷
│   │   ├── 2_OK.png      # 正常
│   │   └── ...
│   └── ...
└── ...
```

#### 2.3 UI 組件

**MainWindow.xaml** 包含：
- **配置區域**: 模型路徑、監控目錄、輸出目錄、工作模式選擇
- **參數控制**: Confidence、Pixel Confidence、IoU 滑塊
- **控制按鈕**: 開始/停止監控、處理按鈕
- **結果預覽**: SkiaSharp 渲染的檢測結果圖像
- **統計面板**: 總處理數、NG/OK 計數、良率
- **日誌輸出**: 實時操作日誌

#### 2.4 配置管理

- **config.json**: 自動保存和讀取路徑配置
- **路徑驗證**: 啟動時驗證配置路徑的有效性
- **默認值**: 自動查找項目根目錄下的默認模型路徑

---

### 3. Demo 項目

項目包含多個 Demo 項目，展示不同功能：

| Demo 項目 | 功能 | 說明 |
|----------|------|------|
| **IndustrySegmentationDemo** | 工業分割檢測 GUI | WPF 圖形界面，單文件/批量處理 |
| **SegmentationDemo** | 分割檢測控制台 | 命令行版本 |
| **ObjectDetectionDemo** | 目標檢測 | 基本目標檢測示例 |
| **ClassificationDemo** | 圖像分類 | 分類任務示例 |
| **OBBDetectionDemo** | 定向邊界框 | 旋轉邊界框檢測 |
| **PoseEstimationDemo** | 姿態估計 | 人體關鍵點檢測 |
| **VideoStreamDemo** | 視頻流處理 | 視頻文件/實時流處理 |
| **WebcamDemo** | 攝像頭檢測 | 實時攝像頭檢測 |
| **BatchDemo** | 批量處理 | 批量圖片處理示例 |
| **YoloE_SegmentationDemo** | YOLO-E 分割 | 提示式分割示例 |
| **TensorRTDemo** | TensorRT 加速 | NVIDIA TensorRT 示例 |
| **CUDADemo** | CUDA 加速 | CUDA 執行提供者示例 |
| **OpenVinoDemo** | OpenVINO 加速 | Intel OpenVINO 示例 |
| **CoreMLDemo** | CoreML 加速 | Apple CoreML 示例 |

---

### 4. 虛擬工控機模擬器 (VirtualIndustrialPC)

#### 4.1 功能

Python 腳本 `virtual_controller.py` 用於模擬工業生產線：

- **生成測試數據**: 根據 OK/NG 圖片生成模擬的生產線數據
- **目錄結構生成**: 自動創建符合系統要求的目錄結構
- **隨機化**: 根據配置的 OK/NG 比率隨機選擇圖片
- **時間模擬**: 模擬工站處理間隔和進料間隔

#### 4.2 配置 (config.json)

```json
{
  "num_stations": 3,              // 工站數量
  "images_per_station": 4,         // 每個工站的圖片數
  "ok_images_path": "ok",           // OK 圖片目錄
  "ng_images_path": "ng",         // NG 圖片目錄
  "output_path": "lines",          // 輸出目錄
  "daily_production": 3,           // 每日產量
  "ok_rate": 0.5,                 // OK 比率
  "ng_rate": 0.5,                 // NG 比率
  "wait_time": 10,                // 進料間隔（秒）
  "station_interval": 5            // 工站處理間隔（秒）
}
```

---

## 🔍 技術細節

### 1. 模型支持

#### 1.1 模型格式要求
- **格式**: ONNX (opset 17)
- **動態模型**: 不支持
- **輸入通道**: 支持 RGB (3通道) 和 Grayscale (1通道)

#### 1.2 預處理配置

**ImageResize 模式**：
- `Proportional`: 保持寬高比（默認，適用於訓練時保持比例的數據集）
- `Stretched`: 拉伸到模型輸入尺寸（適用於訓練時直接拉伸的數據集）

**採樣選項**：
- `Nearest`: 最近鄰採樣（默認，最快）
- `Bilinear`: 雙線性插值
- `Cubic`: 三次插值

**閾值參數**：
- `Confidence`: 檢測置信度閾值（默認 0.2）
- `Pixel Confidence`: 像素置信度閾值（分割任務，默認 0.65）
- `IoU`: 交並比閾值，用於 NMS（默認 0.7）

### 2. 性能優化

#### 2.1 內存管理
- **PinnedMemoryBufferPool**: 使用固定內存池減少 GC 壓力
- **SKBitmap 管理**: 及時釋放圖像資源

#### 2.2 並發處理
- **異步處理**: 使用 `async/await` 避免 UI 阻塞
- **線程安全**: 使用 `Dispatcher.Invoke` 確保 UI 線程安全
- **取消支持**: 支持 `CancellationToken` 取消長時間操作

#### 2.3 圖像處理
- **SkiaSharp**: 高性能 2D 圖形庫
- **硬件加速**: 支持 GPU 加速（通過執行提供者）

### 3. 錯誤處理

#### 3.1 異常類型
- `YoloDotNetException`: 基礎異常
- `YoloDotNetModelException`: 模型相關異常
- `YoloDotNetExecutionProviderException`: 執行提供者異常
- `YoloDotNetVideoException`: 視頻處理異常
- `YoloDotNetModelMismatchException`: 模型類型不匹配異常

#### 3.2 錯誤恢復
- 配置文件路徑驗證失敗時使用默認值
- 圖片加載失敗時跳過並記錄日誌
- 監控錯誤時自動重試

---

## 📊 數據流

### 1. 自動監控模式流程

```
1. 用戶啟動監控
   ↓
2. 初始化 YOLO 模型
   ↓
3. 創建 FileSystemWatcher 監控根目錄
   ↓
4. 檢測到新料號目錄
   ↓
5. 為料號目錄創建工站監控器
   ↓
6. 檢測到新工站目錄
   ↓
7. 掃描工站目錄中的圖片
   ↓
8. 對每張圖片運行分割檢測
   ↓
9. 根據檢測結果標記 NG/OK
   ↓
10. 保存結果到輸出目錄（保持目錄結構）
   ↓
11. 更新統計信息和 UI 顯示
```

### 2. 手動處理模式流程

```
1. 用戶選擇圖片/目錄
   ↓
2. 初始化 YOLO 模型
   ↓
3. 遍歷圖片文件
   ↓
4. 加載圖片
   ↓
5. 運行分割檢測
   ↓
6. 繪製檢測結果
   ↓
7. 保存結果
   ↓
8. 更新 UI（進度、統計、預覽）
```

---

## 🎯 關鍵特性

### 1. 模塊化設計
- 核心庫與執行提供者分離
- 支持多種 YOLO 版本
- 可擴展的模塊接口

### 2. 跨平台支持
- Windows, Linux, macOS
- 多種執行提供者適配不同硬件

### 3. 實時處理
- 目錄監控自動觸發
- 異步處理不阻塞 UI
- 實時結果預覽

### 4. 用戶友好
- 圖形界面操作
- 參數實時調整
- 詳細的日誌輸出
- 統計信息可視化

---

## 🔧 依賴關係

### 核心依賴
```
YoloDotNet (核心)
├── SkiaSharp (3.119.1)
└── [執行提供者] (二選一)
    ├── YoloDotNet.ExecutionProvider.Cpu
    ├── YoloDotNet.ExecutionProvider.Cuda
    ├── YoloDotNet.ExecutionProvider.OpenVINO
    └── YoloDotNet.ExecutionProvider.CoreML
```

### 應用依賴
```
IndustrySegSys
├── YoloDotNet
├── YoloDotNet.ExecutionProvider.Cpu
└── SkiaSharp.Views.WPF
```

---

## 📝 配置文件

### config.json (應用配置)
```json
{
  "ModelPath": "路徑/到/model.onnx",
  "WatchPath": "路徑/到/監控目錄",
  "OutputPath": "路徑/到/輸出目錄",
  "ImagePath": "路徑/到/圖片"
}
```

### config.json (虛擬工控機)
見上文「虛擬工控機模擬器」部分

---

## 🚀 使用場景

### 1. 工業質量檢測
- 產品表面缺陷檢測
- 自動化生產線監控
- 實時質量評估

### 2. 批量處理
- 歷史數據分析
- 離線檢測任務
- 數據標註輔助

### 3. 研發測試
- 模型性能評估
- 參數調優
- 算法驗證

---

## ⚠️ 注意事項

### 1. 模型配置
- **準確度依賴配置**: 預處理和閾值設置必須與訓練時一致
- **ImageResize 模式**: 選擇錯誤會導致準確度下降
- **採樣選項**: 不同採樣方法會影響檢測結果

### 2. 執行提供者
- **只能選擇一個**: 多個執行提供者會導致 DLL 衝突
- **平台限制**: 某些執行提供者僅支持特定平台
- **硬件要求**: CUDA 需要 NVIDIA GPU，OpenVINO 需要 Intel 硬件

### 3. 目錄監控
- **延遲處理**: 目錄創建後有 1 秒延遲，確保目錄完全創建
- **重複處理防護**: 使用 `_processedMaterialDirs` 防止重複處理
- **線程安全**: 使用鎖機制保護共享資源

### 4. 內存管理
- **及時釋放**: SKBitmap 使用完畢後及時釋放
- **大圖片**: 處理大圖片時注意內存使用
- **批量處理**: 大量圖片處理時考慮分批處理

---

## 📈 性能指標

### 處理速度
- **CPU 模式**: 取決於 CPU 性能，通常 100-500ms/圖
- **GPU 模式**: 使用 CUDA 可達到 10-50ms/圖
- **OpenVINO**: Intel 硬件上可達到接近 GPU 的性能

### 內存使用
- **模型加載**: 約 100-500MB（取決於模型大小）
- **圖片處理**: 每張圖片約 10-50MB（取決於圖片尺寸）
- **批量處理**: 建議分批處理，避免內存溢出

---

## 🔮 後續開發建議

### 1. 功能增強
- [ ] 支持多模型切換
- [ ] 添加模型性能分析工具
- [ ] 支持自定義檢測規則
- [ ] 添加數據庫存儲功能
- [ ] 支持遠程監控和報警

### 2. 性能優化
- [ ] 批量推理優化
- [ ] 多線程並發處理
- [ ] 模型量化支持
- [ ] 動態批處理

### 3. 用戶體驗
- [ ] 暗色主題支持
- [ ] 多語言支持
- [ ] 配置導入/導出
- [ ] 結果導出（Excel/CSV）
- [ ] 歷史記錄查詢

### 4. 架構改進
- [ ] 插件系統
- [ ] 微服務架構
- [ ] RESTful API
- [ ] Web 界面

### 5. 測試和文檔
- [ ] 單元測試覆蓋
- [ ] 集成測試
- [ ] 性能基準測試
- [ ] API 文檔完善
- [ ] 用戶手冊

---

## 📚 相關資源

### 文檔
- README.md: 項目主文檔
- Demo/IndustrySegmentationDemo/README.md: Demo 說明
- Demo/SegmentationDemo/README.md: 分割 Demo 說明

### 測試數據
- test/assets/Models/: 模型文件
- test/assets/Media/: 測試圖片/視頻
- VirtualIndustrialPC/: 虛擬工控機測試數據

### 參考資料
- YOLO 官方文檔: https://docs.ultralytics.com
- ONNX Runtime 文檔: https://onnxruntime.ai
- SkiaSharp 文檔: https://docs.microsoft.com/dotnet/api/skiasharp

---

## 📄 許可證

- **YoloDotNet**: GNU General Public License v3.0 or later
- **項目**: 繼承 YoloDotNet 許可證

---

## 👥 維護信息

- **核心庫**: YoloDotNet v4.0
- **作者**: Niklas Swärd
- **項目**: IndustrySeg2 (基於 YoloDotNet 的工業應用)

---

**報告生成時間**: 2025-01-XX
**分析版本**: 1.0
